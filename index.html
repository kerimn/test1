<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8" />
    <title>Ring Try On (Web)</title>
    <link rel="stylesheet" href="style.css" />

    <!-- MediaPipe -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
</head>

<style>
    * {
  box-sizing: border-box;
}

body {
  margin: 0;
  overflow: hidden;
  background: black;
  font-family: Arial, sans-serif;
}

video,
canvas {
  position: absolute;
  width: 100vw;
  height: 100vh;
  object-fit: cover;
}

.frame {
  position: absolute;
  width: 320px;
  height: 320px;
  border: 3px dashed rgba(255, 255, 255, 0.8);
  border-radius: 20px;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
}

.hint {
  position: absolute;
  bottom: 40px;
  width: 100%;
  text-align: center;
  color: white;
  font-size: 18px;
}

</style>

<body>
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas"></canvas>

    <div class="frame"></div>
    <div class="hint" id="hint">–ü–æ–º–µ—Å—Ç–∏—Ç–µ —Ä—É–∫—É –≤ —Ä–∞–º–∫—É</div>

    <script src="script.js"></script>
</body>

<script>
  const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const hint = document.getElementById("hint");

    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    // —Ä–∞–º–∫–∞ (–Ω–µ–º–Ω–æ–≥–æ –±–æ–ª—å—à–µ –¥–ª—è —Ç–µ—Å—Ç–∞)
    const frame = {
        xMin: 0.3,
        xMax: 0.7,
        yMin: 0.2,
        yMax: 0.7
    };

    let stableTime = 0;
    let lastPalm = null;
    let photoTaken = false;
    let savedLandmarks = null;

    // MediaPipe Hands
    const hands = new Hands({
        locateFile: file =>
            `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
    });

    hands.setOptions({
        maxNumHands: 1,
        modelComplexity: 1,
        minDetectionConfidence: 0.7,
        minTrackingConfidence: 0.7
    });

    hands.onResults(results => {
        if (!results.multiHandLandmarks || photoTaken) return;

        const landmarks = results.multiHandLandmarks[0];
        const palm = landmarks[9]; // —Ü–µ–Ω—Ç—Ä –ª–∞–¥–æ–Ω–∏

        // –ø—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ —Ä—É–∫–∞ –≤ —Ä–∞–º–∫–µ
        const inFrame =
            palm.x > frame.xMin &&
            palm.x < frame.xMax &&
            palm.y > frame.yMin &&
            palm.y < frame.yMax;

        // –¥–≤–∏–∂–µ–Ω–∏–µ —Ä—É–∫–∏
        let movement = 1;
        if (lastPalm) {
            movement = Math.hypot(
                palm.x - lastPalm.x,
                palm.y - lastPalm.y
            );
        }

        // –∞–≤—Ç–æ—Ñ–æ—Ç–æ –µ—Å–ª–∏ —Ä—É–∫–∞ –≤ —Ä–∞–º–∫–µ –∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Å—Ç–∞–±–∏–ª—å–Ω–∞
        if (inFrame && movement < 0.03) { // —É–≤–µ–ª–∏—á–µ–Ω –ø–æ—Ä–æ–≥ –¥–≤–∏–∂–µ–Ω–∏—è
            stableTime += 16;
            hint.innerText = "–ù–µ –¥–≤–∏–≥–∞–π—Ç–µ —Ä—É–∫—É‚Ä¶";
        } else {
            stableTime = 0;
            hint.innerText = "–ü–æ–º–µ—Å—Ç–∏—Ç–µ —Ä—É–∫—É –≤ —Ä–∞–º–∫—É";
        }

        lastPalm = palm;

        // —É–º–µ–Ω—å—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è
        if (stableTime > 400) { // —Ä–∞–Ω—å—à–µ –±—ã–ª–æ 700
            console.log("–ê–≤—Ç–æ—Ñ–æ—Ç–æ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç", landmarks);
            capturePhoto(landmarks);
        }
    });

    // üì∏ –∞–≤—Ç–æ—Ñ–æ—Ç–æ
    function capturePhoto(landmarks) {
        if (photoTaken) return;
        photoTaken = true;
        savedLandmarks = landmarks;

        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        drawTestRing();

        hint.innerText = "–ö–æ–ª—å—Ü–æ –Ω–∞–¥–µ—Ç–æ ‚úîÔ∏è";
        console.log("üì∏ –ê–≤—Ç–æ—Ñ–æ—Ç–æ —Å–¥–µ–ª–∞–Ω–æ");
    }

    // üíç —Ç–µ—Å—Ç–æ–≤–æ–µ –∫–æ–ª—å—Ü–æ (canvas)
    function drawTestRing() {
        if (!savedLandmarks) return;

        const base = savedLandmarks[10];
        const tip = savedLandmarks[12];

        const x = base.x * canvas.width;
        const y = base.y * canvas.height;

        const angle = Math.atan2(
            tip.y - base.y,
            tip.x - base.x
        );

        const left = savedLandmarks[9];
        const right = savedLandmarks[13];
        const fingerWidth =
            Math.hypot(
                left.x - right.x,
                left.y - right.y
            ) * canvas.width * 0.6;

        ctx.save();
        ctx.translate(x, y);
        ctx.rotate(angle);

        // –∑–æ–ª–æ—Ç–æ
        ctx.strokeStyle = "#d4af37";
        ctx.lineWidth = fingerWidth * 0.25;
        ctx.beginPath();
        ctx.arc(0, 0, fingerWidth * 0.4, 0, Math.PI * 2);
        ctx.stroke();

        // –±–ª–µ—Å–∫
        ctx.strokeStyle = "rgba(255,255,255,0.5)";
        ctx.lineWidth = fingerWidth * 0.08;
        ctx.beginPath();
        ctx.arc(0, 0, fingerWidth * 0.35, 0, Math.PI * 2);
        ctx.stroke();

        ctx.restore();
    }

    // üì∑ –∫–∞–º–µ—Ä–∞ —Å –æ—Å–Ω–æ–≤–Ω–æ–π (–∑–∞–¥–Ω–µ–π) –∫–∞–º–µ—Ä–æ–π
    navigator.mediaDevices.getUserMedia({
        video: { facingMode: { ideal: "environment" }, width: 1280, height: 720 }
    })
        .then(stream => {
            video.srcObject = stream;

            const cameraMP = new Camera(video, {
                onFrame: async () => {
                    await hands.send({ image: video });
                }
            });
            cameraMP.start();
        })
        .catch(err => {
            console.error("–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã:", err);
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –∫–∞–º–µ—Ä—É. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Chrome.");
        });

</script>

</html>
